<!doctype html>
<html>
<head>
  <title>Whisper中国电话面试</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="created" content="2014-09-02" />
  <meta name="generator" content="human" />
  <meta name="og:title" content="Whisper中国电话面试" />
  <meta name="og:locale" content="zh_CN" />
  <link rel="home" href="/" />
  <link rel="stylesheet" type="text/css" href="../base.css" />
</head>

<body>

<h1>Whisper中国电话面试</h1>

<p>以下内容凭回忆的印象写的，可能和实际出入有点大。</p>

<p>面试过程总的来说很惨。不过，这次面试机会是很意外的，是Whisper的人先联系我的。他们在深圳的办公室正在招一名Erlang程序员。发现我在知乎上比较活跃就来联系我了。</p>

<p>不过，面试的感觉是他们可能是打算招一个Java专家去写Erlang。这是我完全没想到的，我觉得Erlang真没啥好问的，就决定去试试的。整个面试过程差不多就是 ... Actor Model ... Actor Model ... Actor Model ...</p>

<p>一开始先问我为啥用Erlang还不知道是Erlang有啥好处。我说，Erlang语言本身比较简单，没啥记忆的负担，很多东西确实也是用Erlang写起来比较简单。后来才知道，其实他想要的答案是Actor Model，其实所有问题他想要的答案都是Actor Model，而我认为既然是Erlang那些都是理所当然的实在没必要提，所以结果不管说什么他都不满意。我又补充说，Erlang比较好的一点是把错误和异常分清楚了。这也是为什么Joe Armstrong反对defensive programming。实际上用模式匹配相当于到处都是自动defensive programming了。他说，其他语言也可以实现Actor Model，比如Java有Akka，不比Erlang差，问Erlang有啥特别的。我说Akka那种和Erlang完全不是一回事。没有抢占式调度，而且实际上连跑分都不行。的确你两个actor之间互发整数速度可以完爆Erlang，稍微复杂一点的复合类型的消息，时间长了，Scala的平均响应时间会变得很糟糕，特别是响应时间的方差会变得很大，我怀疑是GC的问题。他说，这个确实是，Erlang的per-process GC在这方面比Java好多了。接着问Erlang的异常处理和别的语言的try ... catch有啥区别，以及supervisor的错误处理啥是咋样的，具体那个词是什么记不清了。想不出来，我说Erlang的异常确实是异常，出现异常一般就意味着对应的进程碰到了异常状况该crash了。其实他要的答案是异常通常是由另外一个进程，也就是supervisor处理的。我觉得，异常就该是这样的啊，他这完全是Java中心主义傻傻的连错误和异常都分不清楚的观点，完全不能认同。我直接就想到one_for_one什么的去了，感觉这也没啥可以说的。继续问supervisor重启某个进程的时候，状态该怎么办？答不上来，我觉得这个好像没啥办法，就进程启动的时候去某个地方读呗。这部分就结束了。</p>

<p>后面有一部分是问Erlang调度器的行为。直接就问要自己实现一个Actor Model该怎么做。我说真要做的话，一模一样抄个Erlang算了。他要求自己想。这个可把我难倒了。我说要支持SMP还挺复杂的呢。他说可以先不考虑SMP。我说Erlang实现抢占式，主要就是靠数reduction数。他接着问收发消息怎么办？我说这个还挺复杂的，Erlang有selective receive机制。他说先不考虑这个。我说，消息队列为空还在收消息的话，轮询的时候就跳过吧，发消息就直接插入到对应的消息队列里就好了。他对这个回答不满意，问假如目标不在同一台机器的进程怎么办。我觉得这个怎么发其实都无所谓的，反正又不用保证肯定发到，在一定时间内发到。我说PID那里是可以区分出是否本地进程的。他还是不满意，是占用发送方来发送还是接收方。这个真答不上来。我就说发送方吧。他认为我这样没解释清楚往远程的进程发消息的过程。又问SMP该怎么办。我说直接发过去就是了啊。他又不满意，要问具体用什么数据结构。我觉得用Erlang不就为了别被这些问题折腾么。我说，这个尽量少用锁吧，有竞争的话会影响调度的，尽量靠原子操作和无锁的数据结构解决吧。他又继续问用哪些无锁数据结构，我又答不上来。话说Whisper的人说他们有Erlang大牛，这个问题我觉得还是由我来问他们的大牛比较合适吧。这部分就结束了。</p>

<p>另一部分是，设计一个实时搜索，假设数据全在内存里，后端单台机器的内存里放不下所有数据，所以要有多台后端机器，还有前端机器用于处理请求发往后端。他不断问，用Actor Model该怎么做，这个就是很适合Actor Model的场景，还说这个很简单了，提示的话就直接给答案了。我实在想不出Actor Model和搜索有啥关系。一直在瞎扯这个问题主要是建索引吧，至于是按文档还是按关键词，这个得看具体数据吧，具体咋做真想不出来。他说，没有什么特殊分布，就按文档来吧，怎么样让一台后端机器在过载的情况下，可以将请求转给另一台后端，前后端分别有哪些进程。我还在想建索引的问题。就这样双方来回重复了好多遍，都很尴尬。其实我完全就搞不明白他的思路。他提示，假如前端有个进程代理所有发往后端请求该怎么做。我还是想不出来。其实，他要的答案都是很显然的东西，我实在是很无语啊，这也算答案。这里先不论后端列表的问题，先假设已经有后端列表，专门进程去向后端发，收完所有消息后再发回去。后端响应不过来的话，前端自己去尝试其他后端。我感觉我好蠢啊。</p>

<p>为避免尴尬，他开始翻我GitHub，被他逮到一个画pi-calculus图的东西。他先问，假如要收三个回应，不按顺序到咋办。我说按顺序写就好了。他不满意，说可能不止这三条。我说，pi-calculus可以是全同步的，分成三个channel不影响的，而且pi-calculus里最好收三个消息就只收这三个消息。他说那换回Actor Model。现在要等三种消息，三种消息不断发过来，取收到的每种消息的第一条，合一起发给某个进程，后面的消息直接忽略。我说Erlang有selective receive，按顺序收也没啥问题。他说假设没有selective receive。我觉得就算没有那也是显然的。他说这样中间状态不是很多么。我说，虽然状态多，但是我不管中间状态不就是了。他也没反对。他又问怎么保证消息能可靠从一个进程发到另一个进程。我说保证不了，没准网络就再也连不上了呢，或者另外一个进程就没了呢。他说先不管这些。我说，最多就只能做到发消息超时没收到acknowledge重发，直到收到为止吧。他又说进程还要收别的消息的，我说就再起个进程专做这件事好了。他也不知道说啥好了，就又问了一个问题，假如一个进程向另外一个进程发消息，怎么保证其中两个是有序。我说，这个就和邮件In-Reply-To一样的原理么。他不满意，一定要展开说。他后来好像发现这个确实是差不多的，也就没继续问了。这样就结束了。</p>

<p>我感觉是这些就是为Java程序员准备的。经常写Erlang的话，要么就是用不到，要么就是显然的。当然，不排除是我面试能力太差，该问的问题都还没被问到。</p>

<p>就这样吧。</p>

</body>
</html>
